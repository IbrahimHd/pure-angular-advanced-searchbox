"use strict";angular.module("paasb",["paasb.config"]),angular.module("paasb.config",[]).constant("FILTERS",{SELECTORS:[{name:"Contains",key:"contains",selected:!0,notAllowed:["restrictedSuggestedValues"]},{name:"Is Equal To",key:"isEqualTo"},{name:"Is Not Equal To",key:"isNotEqualTo"}]}),angular.module("paasb").directive("paasbAutoSize",["$parse","$window",function(a,b){return{restrict:"A",controller:["$scope","$element","$attrs",function(c,d,e){e.$observe("paasbAutoSize",function(){var f=a(e.paasbAutoSize)(c),g=function(a,c){return parseInt(b.getComputedStyle(a,null).getPropertyValue(c))},h=0;angular.element(d).ready(function(){var a=f.element.find("input")[0],b=a.getBoundingClientRect(),c=f.element[0].getBoundingClientRect(),e=b.left-c.left;if(f.hasFilterSelectors){var i=f.hasFilterSelectors,j=d[0];i[0].contains(j)||(h=i.find("ul")[0].getBoundingClientRect().height+b.height)}var k=g(a,"border-left-width");d.css("left",e+"px").css("width",b.width-k+"px").css("top",h?h+"px":"auto")})})}]}}]),angular.module("paasb").directive("paasbSearchBoxAddedFilter",["$timeout","$document","paasbUi","paasbUtils",function(a,b,c,d){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-added-filter.html",require:"^paasbSearchBoxFiltering",scope:{filter:"=",filtering:"="},controller:["$scope","$element","$attrs",function(e,f,g){var h,i=e.filtering,j=e.filter,k=null;if(j.loading=!1,"string"==typeof j.suggestedValues){k=i.getConfig();var l=d.getDeepValue(k,j.suggestedValues);l&&(j.suggestedValues=l)}d.isURL(j.suggestedValues)||d.isURL(j.source)&&j.reloadOnCreate?(c.safeApply(e,function(){var a=j.source||j.suggestedValues;angular.extend(j,{loading:!0,suggestedValues:[],source:a})}),i.loadSource(j).then(function(a){c.safeApply(e,function(){angular.extend(j,{suggestedValues:a,loading:!1,value:""})})})):j.value="",angular.extend(e,{Utils:d,events:{searchboxClick:function(a){var b=f[0].contains(a.target),c=f[0]==a.target,d=b||c;d||e.closeFilter()},inputKeyEvents:function(a){13===a.keyCode&&e.closeFilter()}},takeSuggestion:function(a){e.value=a},closeFilter:function(){var a=this;c.safeApply(e,function(){j.editing=!1,b.unbind("click",a.events.searchboxClick),j.value?j.suggestedValue?j.value=j.suggestedValue.value:j.restrictedSuggestedValues&&i.remove(j):i.remove(j)})},openFilter:function(){var c=this;j.editing||(j.editing=!0,a(function(){b.bind("click",c.events.searchboxClick)},25),e.setFocus())},destroy:function(){return i.remove(e.filter)},getElements:function(){return h=f.find("input"),e},registerEvents:function(a){return h.on("keyup",a.inputKeyEvents),e},setFocus:function(){return a(function(){h&&h[0].focus()},50),e},addWatch:function(){return e.$watch("value",function(a){j.value=a||"",j.value&&i.update(j)}),e}}),e.getElements().registerEvents(e.events).addWatch().openFilter()}]}}]),angular.module("paasb").directive("paasbSearchBoxFilterSelectors",["FILTERS",function(a){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-filter-selectors.html",require:"^paasbSearchBoxAddedFilter",scope:{filtering:"=",filter:"="},controller:["$scope","$element","$attrs",function(b,c,d){var e=b.filtering,f=_.cloneDeep(a.SELECTORS),g=b.filter;angular.extend(b,{availableSelectors:null,filter:angular.extend(g,{hasFilterSelectors:c}),takeSelector:function(a){angular.forEach(b.availableSelectors,function(a){a.selected=!1}),g.selector=a,a.selected=!0,g.value&&e.update(g)},setDefaultSelector:function(){if(angular.forEach(b.availableSelectors,function(a){a.selected&&(g.selector=a)}),!g.selector&&b.availableSelectors&&b.availableSelectors.length){var a=b.availableSelectors[0];a.selected=!0,g.selector=a}return b},setAvailableSelectors:function(){var a=[];return angular.forEach(f,function(b){var c=!0;angular.forEach(b.notAllowed,function(a){g[a]&&(c=!1)}),c&&a.push(b)}),b.availableSelectors=a,b}}),b.setAvailableSelectors().setDefaultSelector()}]}}]),angular.module("paasb").directive("paasbSearchBoxFiltering",[function(){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-filtering.html",require:"^paasbSearchBox",scope:{filters:"=",search:"="},controller:["$scope","$element","$attrs",function(a,b,c){var d=null;a.$watch("search",function(b,c){b!==c&&angular.isObject(b)&&(d=b,a.filters=_.cloneDeep(a.filters),a.filters.slice().reverse().forEach(function(b,c,d){b.notFiltered=!0,b.dontFilter&&a.filters.splice(d.length-1-c,1)}),angular.extend(a,{addFilter:function(b){var c=angular.element(b.target),e=c.attr("data-filter-name");angular.forEach(a.filters,function(a){a.name===e&&(a.restrictedSuggestedValues?d.Filtering.add(a):(a.notFiltered=!a.notFiltered,a.notFiltered||d.Filtering.add(a)))})}}))})}]}}]),angular.module("paasb").directive("paasbSearchBox",["paasbUi","paasbFiltering",function(a,b){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox.html",scope:{searchParams:"=?",paasbSearchBoxFiltering:"=?",paasbSearchBoxConfig:"=?",placeholder:"@"},controller:["$scope","$element","$attrs",function(c,d,e){var f=null,g=null,h=null,i={searchInputId:"searchInput-"+_.uuid(),make:function(a,b,d){return angular[d](c[a])||("isObject"===d?c[a]=angular.extend({},b):c[a]=b),this},events:{handleGarbage:function(){(f.query&&f.query.length||c.hasFilters)&&(angular.extend(f,{query:"",filters:[]}),angular.forEach(f,function(a){"query"!==a&&delete f[a]}),h.removeAll())}},configure:function(){return this.make("searchParams",{query:"",filters:[]},"isObject").make("paasbSearchBoxFiltering",[],"isArray").make("paasbSearchBoxConfig",{},"isObject"),f=c.searchParams,g=c.paasbSearchBoxConfig,a.extend(c,{searchInputId:this.searchInputId}),this},addEvents:function(){return angular.extend(c,this.events),h.watch(function(a){f.filters=a}),this},register:function(){return h=new b(c,g),angular.extend(c,{Search:{Filtering:h}}),this},dom:function(){var b=angular.element(document.getElementById(this.searchInputId)),d=b.parent();return a.extend(c,{input:b,wrapper:d}),this}};angular.element(d).ready(function(){i.configure().register().addEvents().dom()})}]}}]),angular.module("paasb").filter("suggest",[function(){return _.memoize(function(a,b,c,d){if(!b){var e=[];return angular.forEach(a,function(a){e.push({modified:a,value:a})}),e}var f=[],g=new String(b);return angular.forEach(a,function(a){var b=a.toLowerCase(),c=g.toLowerCase();if(-1!==b.indexOf(c)){for(var d=[],e=!0,h=-1;e;)if(h=b.indexOf(c,d.length?h+1:h),-1!==h){var i=c.length;d.push({start:h,end:i,len:i-1})}else e=!1;var j=a,k=0;angular.forEach(d,function(a){var b=j.substr(0,a.start+k),c="<b>"+j.substr(a.start+k,a.end)+"</b>",d=j.substr(a.start+k+1+a.len,j.length);j=b+c+d,k+=7})}j&&f.push({modified:j,value:a})}),c.suggestedValue=f&&f.length?f[0]:null,f},function(a,b){return a.length+b})}]),angular.module("paasb").factory("paasbFiltering",["$q","$compile","$http","paasbUi",function(a,b,c,d){var e=null,f=null;return function(g,h){e=g,f=h;var i=null;e.$watch("Search",function(a,b){angular.isObject(a)&&(i=a)}),angular.extend(e,{addedFilters:[],addedScopes:{}}),angular.extend(this,{getConfig:function(){return f},watch:function(a){this.callback=a},update:function(){this.callback(this.buildParameters())},buildParameters:function(){var a={};return angular.forEach(e.paasbSearchBoxFiltering,function(b){angular.forEach(e.addedFilters,function(c){c.name===b.name&&(a[c.name]||(a[c.name]=[]),a[c.name].push({condition:c.selector.key,value:c.value}))})}),a},add:function(a){var c=e.$new(!0),f=_.clone(a);angular.extend(c,{filter:f,filtering:this});var g=b('<paasb-search-box-added-filter filter="filter" filtering="filtering" />')(c);e.wrapper.prepend(g),angular.extend(f,{element:g,$filter:a,uuid:_.uuid()}),e.addedScopes[f.uuid]=c,d.safeApply(e,function(){e.hasFilters=!0,e.addedFilters.push(f)})},remove:function(a){e.addedFilters.slice().reverse().forEach(function(b,c,d){if(b.uuid===a.uuid){b.element.remove();var f=e.addedScopes[a.uuid];f&&(f.$destroy(),delete e.addedScopes[a.uuid]),a.$filter.notFiltered=!0,e.addedFilters.splice(d.length-1-c,1)}}),e.addedFilters&&!e.addedFilters.length&&(e.hasFilters=!1)},removeAll:function(){var a=this;e.addedFilters.slice().reverse().forEach(function(b){return a.remove(b)})},loadSource:function(b){var d=a.defer();return c.get(b.source).then(function(a){return b.suggestedDataPoint?d.resolve(a&&a.data[b.suggestedDataPoint]?a.data[b.suggestedDataPoint]:null):d.resolve(a?a.data:null)}),d.promise}})}}]),angular.module("paasb").factory("paasbUi",["$timeout",function(a){var b={extend:function(a,b){this.safeApply(a,function(){angular.extend(a,b)})},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?b&&"function"==typeof b&&b():a.$apply(b)},apply:function(b,c){return a(b,c||0)}};return b}]),angular.module("paasb").factory("paasbUtils",["$sce",function(a){var b={trust:function(b){return a.trustAsHtml(b)},isURL:function(a){var b="^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$",c=new RegExp(b,"i");return c.test(a)},getDeepValue:function(a,b){for(var c,d=b.split("."),e=a,f=0;f<d.length;++f){if(c=e[d[f]],"undefined"==typeof c)return;e=c}return e}};return b}]),angular.module("paasb").run(["$templateCache",function(a){a.put("views/directives/searchbox-added-filter.html",'\n<div ng-click="openFilter();" class="paasb-searchbox-added-filter"><span ng-bind="filter.displayName + \':\'"></span><span ng-bind="filter.selector.name" ng-if="filter.selector" class="selector-type"></span><span ng-bind="filter.value" ng-hide="filter.editing"></span>\n  <input type="text" ng-model="value" ng-hide="!filter.editing"/><span ng-hide="!filter.loading">Loading...</span>\n  <paasb-search-box-filter-selectors filtering="filtering" filter="filter"></paasb-search-box-filter-selectors>\n  <div ng-if="filter.suggestedValues">\n    <ul ng-hide="!filter.editing" paasb-auto-size="filter" ng-if="!filter.loading">\n      <li ng-repeat="suggestion in filter.suggestedValues | suggest: filter.value:filter" ng-click="takeSuggestion(suggestion.value)"><span ng-bind-html="Utils.trust(suggestion.modified)"></span></li>\n    </ul>\n  </div><i ng-click="destroy();" class="fa fa-times"></i>\n</div>'),a.put("views/directives/searchbox-filter-selectors.html",'\n<div ng-class="{ \'loaded\' : !filter.loading }" ng-hide="!filter.editing" class="paasb-searchbox-filter-selectors">\n  <ul paasb-auto-size="filter">\n    <li ng-repeat="selector in availableSelectors" ng-class="{ \'active\': selector.selected }" ng-click="takeSelector(selector);"><span ng-bind="selector.name"></span></li>\n  </ul>\n</div>'),a.put("views/directives/searchbox-filtering.html",'\n<div class="paasb-filtering paasb-clearfix"><span>Filters:</span>\n  <ul>\n    <li ng-repeat="filter in filters" data-filter-name="{{filter.name}}" ng-bind="filter.displayName" ng-click="addFilter($event);" ng-if="filter.notFiltered"></li>\n  </ul>\n</div>'),a.put("views/directives/searchbox.html",'\n<div class="paasb-searchbox">\n  <div class="paasb-searchbox-wrapper"><i ng-class="{ \'fa-search\': !searchParams.query.length, \'fa-trash\': ((searchParams.query &amp;&amp; searchParams.query.length) || hasFilters) }" ng-click="handleGarbage();" class="fa"></i>\n    <input type="text" ng-model="searchParams.query" placeholder="{{placeholder}}" id="{{searchInputId}}"/>\n  </div>\n  <paasb-search-box-filtering search="Search" filters="paasbSearchBoxFiltering" ng-if="paasbSearchBoxFiltering &amp;&amp; paasbSearchBoxFiltering.length"></paasb-search-box-filtering>\n</div>')}]);