"use strict";angular.module("paasb",["paasb.config"]),angular.module("paasb.config",[]).constant("FILTERS",{SELECTORS:[{name:"Contains",key:"contains",selected:!0,notAllowed:["restrictedSuggestedValues"]},{name:"Is Equal To",key:"isEqualTo"},{name:"Is Not Equal To",key:"isNotEqualTo"},{name:"Starts with",key:"startsWith"},{name:"Ends with",key:"endsWith"}]}),angular.module("paasb").directive("paasbAutoSize",["$parse","$window","$timeout","paasbUtils",function(a,b,c,d){return{restrict:"A",controller:["$scope","$element","$attrs",function(b,e,f){var g=null;b.reAutoSize=function(){var a=0;c(function(){var b=g.element.find("input")[0],c=b.getBoundingClientRect(),f=(g.element[0].getBoundingClientRect(),c.left);if(g.hasFilterSelectors){var h=g.hasFilterSelectors,i=e[0];h[0].contains(i)||(a=h.find("ul")[0].getBoundingClientRect().height+c.height)}var j=d.getStyle(b,"border-left-width");e.css("left",f+"px").css("width",c.width-j+"px").css("top",a?a+"px":"auto")})},f.$observe("paasbAutoSize",function(){g=a(f.paasbAutoSize)(b),angular.element(e).ready(function(){b.reAutoSize()})})}]}}]),angular.module("paasb").directive("paasbSearchBoxAddedFilter",["$timeout","$document","paasbUi","paasbUtils",function(a,b,c,d){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-added-filter.html",require:"^paasbSearchBoxFiltering",scope:{filter:"=",filtering:"=",toValue:"="},controller:["$scope","$element","$attrs",function(e,f,g){var h,i=e.filtering,j=e.filter,k=null;if(j.loading=!1,"string"==typeof j.suggestedValues){k=i.getConfig();var l=d.getDeepValue(k,j.suggestedValues);l&&(j.suggestedValues=l)}e.toValue&&(e.value=e.toValue,e.dontOpen=!0),d.isURL(j.suggestedValues)||d.isURL(j.source)&&j.reloadOnCreate?(c.safeApply(e,function(){var a=j.source||j.suggestedValues;angular.extend(j,{loading:!0,suggestedValues:[],source:a})}),i.loadSource(j).then(function(a){c.safeApply(e,function(){angular.extend(j,{suggestedValues:a,loading:!1,value:""})})})):j.value="",angular.extend(e,{Utils:d,events:{searchboxClick:function(a){var b=f[0].contains(a.target),c=f[0]==a.target,d=b||c;d||e.closeFilter()},inputKeyEvents:function(a){13===a.keyCode&&e.closeFilter()}},takeSuggestion:function(a){e.value=a},closeFilter:function(){var a=this;c.safeApply(e,function(){j.editing=!1,e.$broadcast("filter.isEditing",j.editing),b.unbind("click",a.events.searchboxClick),j.value?j.suggestedValue?j.value=j.suggestedValue.value:j.restrictedSuggestedValues&&i.remove(j):i.remove(j)})},openFilter:function(){if(!e.dontOpen){var c=this;j.editing||(j.editing=!0,e.$broadcast("filter.isEditing",j.editing),a(function(){b.bind("click",c.events.searchboxClick)},25),e.setFocus())}e.dontOpen=!1},destroy:function(){return i.remove(e.filter)},getElements:function(){return h=f.find("input"),e},registerEvents:function(a){return h.on("keyup",a.inputKeyEvents),e},setFocus:function(){return a(function(){h&&h[0].focus()},50),e},addWatch:function(){return e.$watch("value",function(a){j.value=a||"",j.value&&i.update()}),e}}),e.getElements().registerEvents(e.events).addWatch().openFilter()}]}}]),angular.module("paasb").directive("paasbSearchBoxAutoComplete",["$window","$document","$timeout","paasbUi","paasbUtils","paasbAutoComplete","paasbMemory",function(a,b,c,d,e,f,g){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-auto-complete.html",require:"^paasbSearchBox",scope:{query:"=",config:"=",input:"="},controller:["$scope","$element",function(h,i){var j=h.config,k=g.getAndSet("query");h.$watch("query",function(a){h.tookSuggestion!==a&&(h.tookSuggestion=null,a&&k!==a&&f.load(j.autoCompleteUrl).then(function(a){h.autoSuggestions=a,h.showSuggestions=!0,h.position()}))}),angular.extend(h,{Utils:e,tookSuggestion:null,showSuggestions:!1,autoCompleteClick:function(a){var c=a.target,e=i[0];e.contains(c)||d.extend(h,{showSuggestions:!1}),b.unbind("click",h.autoCompleteClick)},position:function(){c(function(){var a=h.input[0],b=e.getStyle(a,"padding-left"),c=e.getStyle(a,"width")-e.getStyle(a,"padding-right")-b;i.css("left",b+"px").css("width",c+"px")})},takeAutoComplete:function(a){d.extend(h,{showSuggestions:!1,tookSuggestion:a}),h.$emit("take.autoSuggestion",a),b.unbind("click",h.autoCompleteClick)},registerEvents:function(){return angular.element(a).on("resize",function(){h.position()}),h.$on("input.focused",function(){h.autoSuggestions&&h.autoSuggestions.length&&d.extend(h,{showSuggestions:!0})}),h.$watch("showSuggestions",function(a){a&&b.bind("mousedown",h.autoCompleteClick)}),h}}),h.registerEvents()}]}}]),angular.module("paasb").directive("paasbSearchBoxCacheFilter",["paasbMemory","paasbUi",function(a,b){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-cache-filters.html",require:"^paasbSearchBox",controller:["$scope",function(c){b.extend(c,{cacheActive:a.getAndSet("cache")||!1,handleCache:function(){c.cacheActive=!c.cacheActive,a.getAndSet("cache",c.cacheActive)}})}]}}]),angular.module("paasb").directive("paasbSearchBoxFilterSelectors",["FILTERS",function(a){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-filter-selectors.html",require:"^paasbSearchBoxAddedFilter",scope:{filtering:"=",filter:"="},controller:["$scope","$element","$attrs",function(b,c,d){var e=b.filtering,f=_.cloneDeep(a.SELECTORS),g=b.filter;angular.extend(b,{availableSelectors:null,filter:angular.extend(g,{hasFilterSelectors:c}),takeSelector:function(a){angular.forEach(b.availableSelectors,function(a){a.selected=!1}),g.selector=a,a.selected=!0,g.value&&e.update(),b.reAutoSize();var c=g.element.find("input")[0];c.focus()},setDefaultSelector:function(){if(g.selector)angular.forEach(b.availableSelectors,function(a){a.selected=a.key===g.selector.key});else if(angular.forEach(b.availableSelectors,function(a){a.selected&&(g.selector=a)}),!g.selector&&b.availableSelectors&&b.availableSelectors.length){var a=b.availableSelectors[0];a.selected=!0,g.selector=a}return b},setAvailableSelectors:function(){var a=[];return angular.forEach(f,function(b){var c=!0;angular.forEach(b.notAllowed,function(a){g[a]&&(c=!1)}),c&&a.push(b)}),b.availableSelectors=a,b}}),b.$on("filter.isEditing",function(a,c){c&&b.reAutoSize()}),b.setAvailableSelectors().setDefaultSelector()}]}}]),angular.module("paasb").directive("paasbSearchBoxFiltering",["$document","$timeout","$window","paasbUtils","paasbUi",function(a,b,c,d,e){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox-filtering.html",require:"^paasbSearchBox",scope:{filters:"=",search:"="},controller:["$scope","$element","$attrs",function(f,g,h){var i=null;f.$watch("active",function(c,d){c&&!f.windowClickedFn?b(function(){f.windowClickedFn=a.on("click",f.windowClicked)},25):f.windowClickedFn&&(a.off("click",f.windowClicked),f.windowClickedFn=null)}),angular.extend(f,{active:!1,Utils:d,windowClicked:function(a){var b=a.target,c=g[0];c.contains(b)||e.extend(f,{active:!1})},position:function(){f.active&&b(function(){var a=g.parent(),b=g.find("ul"),c=(b[0].getBoundingClientRect(),a[0].getBoundingClientRect());b.css("top",c.height-5+"px").css("width",c.width+d.getStyle(a[0],"padding-right")+d.getStyle(a[0],"padding-left")+"px")},25)},toggleFilters:function(){e.extend(f,{active:!f.active}),this.position()},addFilterAndClose:function(a){i.Filtering.add(a),e.extend(f,{active:!f.active})},getParentByAttribute:function(a,b,c){var d=!0,e=null;for(a=angular.element(a);d&&a[0]!==document;){var f=a[0].nodeName.toLowerCase();if(f===b.toLowerCase()&&a.attr(c)){e=a,d=!1;break}a=a.parent()}return e},registerEvents:function(){angular.element(c).on("resize",function(){f.position()})},addFilter:function(a){var b=this,c=b.getParentByAttribute(a.target,"li","data-filter-name"),d=c.attr("data-filter-name");angular.forEach(f.filters,function(a){a.name===d&&(a.restrictedSuggestedValues?b.addFilterAndClose(a):(a.notFiltered=!a.notFiltered,a.notFiltered||b.addFilterAndClose(a)))})}}),f.$watch("search",function(a,b){a!==b&&angular.isObject(a)&&(i=a,f.filters=_.cloneDeep(f.filters),f.filters.slice().reverse().forEach(function(a,b,c){a.notFiltered=!0,a.root&&(a.filteredFrom='<i class="fa fa-level-up"></i> (Derived from Root <i class="fa fa-angle-double-right"></i> '+a.root+")"),a.child&&(a.filteredFrom='<i class="fa fa-level-down"></i> (Derived from '+a.child+")"),a.dontFilter&&f.filters.splice(c.length-1-b,1)}),f.registerEvents())})}]}}]),angular.module("paasb").directive("paasbSearchBox",["$timeout","$window","paasbUi","paasbFiltering","paasbMemory",function(a,b,c,d,e){return{restrict:"E",replace:!0,templateUrl:"views/directives/searchbox.html",scope:{searchParams:"=?",paasbSearchBoxFiltering:"=?",paasbSearchBoxConfig:"=?",paasbSearchBoxAutoComplete:"=?",paasbSearchBoxCacheFilter:"=?",placeholder:"@"},controller:["$scope","$element","$attrs",function(b,f,g){var h=null,i=null,j=null,k=null,l=null,m={searchInputId:"searchInput-"+_.uuid(),hasAutoCompleteConfigurations:function(){return i&&i.autoCompleteUrl},make:function(a,c,d,e){var f=b[a];return angular[d]?angular[d](f)?c&&_.isEmpty(f)&&(b[a]=c,b[e]=c[e]):f="isObject"===d?angular.extend({},c):c:this[d]&&(f=this[d](f)),this},events:{handleGarbage:function(){(h.query&&h.query.length||b.hasFilters)&&(angular.extend(h,{query:"",filters:{}}),b.query="",angular.forEach(h,function(a){"query"!==a&&delete h[a]}),k.removeAll())}},shouldStore:function(){return!(!e.getAndSet("cache")&&!b.paasbSearchBoxConfig.store)},configure:function(){var a={query:"",filters:{}};return this.make("searchParams",this.shouldStore()?e.getAll():a,"isObject","query").make("paasbSearchBoxFiltering",[],"isArray").make("paasbSearchBoxConfig",{},"isObject").make("paasbSearchBoxAutoComplete",{},"isObject"),this.shouldStore()||e.removeAll(),h=b.searchParams,i=b.paasbSearchBoxConfig,j=b.paasbSearchBoxAutoComplete,b.autoCompleteEnabled=this.hasAutoCompleteConfigurations(),c.extend(b,{searchInputId:this.searchInputId}),this},addEvents:function(){return angular.extend(b,this.events),k.watch(function(b,c){e.getAndSet("filters",b),l&&a.cancel(l),i.delay&&!c?l=a(function(){h.filters=b},i.delay):h.filters=b}),b.$on("take.autoSuggestion",function(a,c){b.skipDelay=!0,b.query=c}),b.$watch("query",function(c){"undefined"!=typeof c&&e.getAndSet("query")!==c&&(e.getAndSet("query",c),i.delay&&!b.skipDelay?(l&&a.cancel(l),l=a(function(){h.query=c},i.delay)):(l&&a.cancel(l),b.skipDelay=!1,h.query=c))}),b.input.on("focus",function(){b.$broadcast("input.focused")}),this},register:function(){return k=new d(b,i),angular.extend(b,{Search:{Filtering:k}}),k.addByMemory(h),this},dom:function(){var a=angular.element(document.getElementById(this.searchInputId)),d=a.parent();return c.extend(b,{input:a,wrapper:d}),this}};angular.element(f).ready(function(){m.configure().dom().register().addEvents()})}]}}]),angular.module("paasb").filter("suggest",[function(){return _.memoize(function(a,b,c,d){if(!b){var e=[];return angular.forEach(a,function(a){e.push({modified:a,value:a})}),e}var f=[],g=new String(b);return angular.forEach(a,function(a){var b=a.toLowerCase(),c=g.toLowerCase();if(-1!==b.indexOf(c)){for(var d=[],e=!0,h=-1;e;)if(h=b.indexOf(c,d.length?h+1:h),-1!==h){var i=c.length;d.push({start:h,end:i,len:i-1})}else e=!1;var j=a,k=0;angular.forEach(d,function(a){var b=j.substr(0,a.start+k),c="<b>"+j.substr(a.start+k,a.end)+"</b>",d=j.substr(a.start+k+1+a.len,j.length);j=b+c+d,k+=7})}j&&f.push({modified:j,value:a})}),c.suggestedValue=f&&f.length?f[0]:null,f},function(a,b){return a.length+b})}]),angular.module("paasb").factory("paasbAutoComplete",["$q","$http",function(a,b){var c={load:function(c){var d=a.defer();return b({method:"GET",url:c}).then(function(a){a&&a.data&&d.resolve(a.data)},function(){d.resolve([])}),d.promise}};return c}]),angular.module("paasb").factory("paasbFiltering",["$q","$compile","$http","paasbUi","paasbMemory","paasbValidation","FILTERS",function(a,b,c,d,e,f,g){var h=null,i=null;return function(j,k){h=j,i=k;var l=null;h.$watch("Search",function(a,b){angular.isObject(a)&&(l=a)}),angular.extend(h,{addedFilters:[],addedScopes:{}}),angular.extend(this,{getConfig:function(){return i},watch:function(a){this.callback=a},update:function(a){return this.callback?this.callback(this.buildParameters(),a):void 0},buildParameters:function(){var a={};return angular.forEach(h.paasbSearchBoxFiltering,function(b){angular.forEach(h.addedFilters,function(c){if(c.name===b.name){var d=function(){a[c.name]||(a[c.name]=[]);var b={condition:c.selector.key,value:c.value};angular.extend(b,c.extend||{}),a[c.name].push(b)};f.has(c)?f.validate(c)&&d():d()}})}),a},getFilterContainer:function(){if(!this.filterContainerId){this.filterContainerId=_.uuid();var a=document.createElement("div");a.id=this.filterContainerId,angular.element(a).attr("ng-hide","!addedFilters.length").addClass("paasb-added-filters-wrapper paasb-clearfix"),h.wrapper.parent().append(b(a)(h))}return angular.element(document.getElementById(this.filterContainerId))},addByMemory:function(a){var b=a.filters,c=this;angular.forEach(b,function(a,b){angular.forEach(a,function(a){angular.forEach(h.paasbSearchBoxFiltering,function(d){b===d.name&&c.add(d,a)})})})},add:function(a,c){var e=h.$new(!0),f=_.clone(a);angular.extend(e,{filter:f,filtering:this,toValue:c&&c.value?c.value:null});var i=b('<paasb-search-box-added-filter filter="filter" filtering="filtering" to-value="toValue" />')(e);this.getFilterContainer().append(i),angular.extend(f,{element:i,$filter:a,uuid:_.uuid()}),c&&c.condition&&angular.forEach(g.SELECTORS,function(a){a.key===c.condition&&(f.selector=a)}),h.addedScopes[f.uuid]=e,d.safeApply(h,function(){h.hasFilters=!0,h.addedFilters.push(f)})},remove:function(a){h.addedFilters.slice().reverse().forEach(function(b,c,d){if(b.uuid===a.uuid){b.element.remove();var e=h.addedScopes[a.uuid];e&&(e.$destroy(),delete h.addedScopes[a.uuid]),a.$filter.notFiltered=!0,h.addedFilters.splice(d.length-1-c,1)}}),h.addedFilters&&!h.addedFilters.length&&(h.hasFilters=!1),this.update(!0)},removeAll:function(){var a=this;h.addedFilters.slice().reverse().forEach(function(b){return a.remove(b)}),e.removeAll()},loadSource:function(b){var d=a.defer();return c.get(b.source).then(function(a){return b.suggestedDataPoint?d.resolve(a&&a.data[b.suggestedDataPoint]?a.data[b.suggestedDataPoint]:null):d.resolve(a?a.data:null)}),d.promise}})}}]),angular.module("paasb").factory("paasbMemory",["$window",function(a){var b=a.localStorage,c={hash:"paasb",getAndSet:function(a,c){b.getItem(this.hash)||b.setItem(this.hash,"{}");var d=b.getItem(this.hash);if(d){if(d=JSON.parse(d),"undefined"==typeof c)return d[a];d[a]=c,b.setItem(this.hash,JSON.stringify(d))}},getAll:function(){var a=JSON.parse(b.getItem(this.hash));return a?(delete a.cache,a):{}},removeAll:function(){var a=this.getAndSet("cache"),c={};null!==a&&(c.cache=a),b.setItem(this.hash,JSON.stringify(c))}};return c}]),angular.module("paasb").factory("paasbUi",["$timeout",function(a){var b={extend:function(a,b){this.safeApply(a,function(){angular.extend(a,b)})},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?b&&"function"==typeof b&&b():a.$apply(b)},apply:function(b,c){return a(b,c||0)}};return b}]),angular.module("paasb").factory("paasbUtils",["$sce","$window",function(a,b){var c={getStyle:function(a,c){return parseInt(b.getComputedStyle(a,null).getPropertyValue(c))},trust:function(b){return a.trustAsHtml(b)},isURL:function(a){var b="^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$",c=new RegExp(b,"i");return c.test(a)},getDeepValue:function(a,b){for(var c,d=b.split("."),e=a,f=0;f<d.length;++f){if(c=e[d[f]],"undefined"==typeof c)return;e=c}return e}};return c}]),angular.module("paasb").factory("paasbValidation",["$window",function(a){var b={length:function(a,b){return a.length===parseInt(b)},has:function(a){return!!a.validation},validate:function(a){var b=this,c=[],d=[];return a&&a.validation?(c=a.validation.split(" "),angular.forEach(c,function(c){var e=c.split("="),f=e[0],g=e[1];b[f](a.value,g)&&d.push({name:f,value:g})}),c.length===d.length):!0}};return b}]),angular.module("paasb").run(["$templateCache",function(a){a.put("views/directives/searchbox-added-filter.html",'\n<div ng-click="openFilter();" ng-class="{ \'child\': filter.child, \'root\': filter.root }" class="paasb-searchbox-added-filter"><span ng-bind="filter.displayName + \':\'" class="filter-name"></span><span ng-bind="filter.selector.name" ng-if="filter.selector" class="selector-type"></span><span ng-bind="filter.value" ng-hide="filter.editing" class="filter-value"></span>\n  <input type="text" ng-model="value" ng-hide="!filter.editing"/><span ng-hide="!filter.loading">Loading...</span>\n  <paasb-search-box-filter-selectors filtering="filtering" filter="filter"></paasb-search-box-filter-selectors>\n  <div ng-if="filter.suggestedValues">\n    <ul ng-hide="!filter.editing" paasb-auto-size="filter" ng-if="!filter.loading">\n      <li ng-repeat="suggestion in filter.suggestedValues | suggest: filter.value:filter" ng-click="takeSuggestion(suggestion.value)"><span ng-bind-html="Utils.trust(suggestion.modified)"></span></li>\n    </ul>\n  </div><i ng-click="destroy();" class="fa fa-times"></i>\n</div>'),a.put("views/directives/searchbox-auto-complete.html",'\n<div ng-hide="!showSuggestions" class="paasb-auto-complete-container">\n  <p>Most Popular Suggestions</p>\n  <ul>\n    <li ng-repeat="suggestion in autoSuggestions" ng-click="takeAutoComplete(suggestion.value);"><span ng-bind="suggestion.value" class="suggestion-value"></span><span ng-bind-html="Utils.trust(\' - Suggested &lt;b&gt;\' + suggestion.suggestedCount + \'&lt;/b&gt; times\')" class="suggestion-count"></span></li>\n  </ul>\n</div>'),a.put("views/directives/searchbox-cache-filters.html",'<i ng-class="{ \'active\': cacheActive }" ng-click="handleCache();" class="paasb-search-box-cache-filter fa fa-archive"></i>'),a.put("views/directives/searchbox-filter-selectors.html",'\n<div ng-class="{ \'loaded\' : !filter.loading }" ng-hide="!filter.editing" class="paasb-searchbox-filter-selectors">\n  <ul paasb-auto-size="filter">\n    <li ng-repeat="selector in availableSelectors" ng-class="{ \'active\': selector.selected }" ng-click="takeSelector(selector);"><span ng-bind="selector.name"></span></li>\n  </ul>\n</div>'),a.put("views/directives/searchbox-filtering.html",'\n<div class="paasb-filtering paasb-clearfix"><span ng-click="toggleFilters();" ng-class="{ \'active\': active }"><i class="fa fa-filter"></i></span>\n  <ul ng-hide="!active">\n    <li ng-repeat="filter in filters" data-filter-name="{{filter.name}}" ng-class="{ \'child-filter\': filter.child, \'root-filter\': filter.root }" ng-click="addFilter($event);" ng-if="filter.notFiltered"><i class="fa fa-filter"></i><span ng-bind="filter.displayName" class="filter-display-name"></span><span ng-bind-html="Utils.trust(filter.filteredFrom)" class="filtered-from"></span></li>\n  </ul>\n</div>'),a.put("views/directives/searchbox.html",'\n<div class="paasb-searchbox">\n  <paasb-search-box-filtering search="Search" filters="paasbSearchBoxFiltering" ng-if="paasbSearchBoxFiltering &amp;&amp; paasbSearchBoxFiltering.length"></paasb-search-box-filtering>\n  <div class="paasb-searchbox-wrapper"><i ng-class="{ \'fa-search\': !searchParams.query.length, \'fa-trash\': ((searchParams.query &amp;&amp; searchParams.query.length) || hasFilters) }" ng-click="handleGarbage();" class="fa"></i>\n    <paasb-search-box-cache-filter ng-if="paasbSearchBoxCacheFilter"></paasb-search-box-cache-filter>\n    <input type="text" ng-model="query" placeholder="{{placeholder}}" id="{{searchInputId}}"/>\n    <paasb-search-box-auto-complete query="searchParams.query" config="paasbSearchBoxAutoComplete" input="input" ng-if="autoCompleteEnabled"></paasb-search-box-auto-complete>\n  </div>\n</div>')}]);